<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Curse is Bound</title>
<style>
  :root { color-scheme: dark; }
  *,*::before,*::after { box-sizing: border-box; }

  html, body {
    margin: 0; height: 100%;
    background: #0b0b0d url("./begin/beginbkg.png") no-repeat center center fixed;
    background-size: cover;
    color: #eae9ef;
    font: 16px/1.55 ui-sans-serif, system-ui, -apple-system, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
  }

  .wrap { max-width: 720px; margin: 10vh auto; padding: 0 20px; text-align: center; }

  .title {
    font-size: clamp(28px, 5.6vw, 42px);
    font-weight: 800;
    letter-spacing: .02em;
    margin: 0 0 14px;
    line-height: 1.2;
    text-shadow: 0 2px 14px rgba(0,0,0,.35);
  }

  .intro {
    font-size: clamp(14px, 2.3vw, 18px);
    color:#c9c7d4;
    line-height: 1.6;
    margin: 0 auto 18px;
    max-width: 48ch;
    text-shadow: 0 2px 10px rgba(0,0,0,.35);
  }

  .card {
    max-width: 560px; width: 100%;
    margin: 22px auto 0; padding: 28px;
    border: 1px solid #3a3847; border-radius: 16px;
    background: linear-gradient(180deg, rgba(11,11,13,.92), rgba(18,18,23,.92));
    backdrop-filter: blur(2px);
    box-shadow: 0 10px 40px rgba(0,0,0,.6);
    text-align: center;
  }

  .prompt {
    font-size: clamp(15px, 2.4vw, 18px);
    color:#c9c7d4;
    line-height: 1.6;
    margin: 0 0 16px;
  }

  input[type="text"]{
    background:#121217; border:1px solid #242432; color:#eae9ef;
    padding:12px 14px; border-radius:10px; outline:none; width:100%;
    max-width: 420px;
  }
  input::placeholder{ color:#8a8996; }

  .preview {
    font-size: 13px; color:#c9c7d4; opacity:.95;
    margin: 6px auto 10px; max-width: 48ch;
  }
  .preview b { color:#eae9ef; }

  .actions { margin-top: 14px; }
  button{
    background:#2a2834; border:1px solid #3a3847; color:#eae9ef;
    padding:12px 16px; border-radius:10px; cursor:pointer; width:100%;
    max-width:280px; font-weight:700; letter-spacing:.02em;
    text-transform: none;
  }
  button:hover{ background:#343244; }

  .msg { margin-top: 16px; min-height: 64px; }
  .status-text { color:#f5c473; font-size: 15px; opacity: 0; transition: opacity .8s ease; }
  .status-text.show { opacity: 1; }
  .spinner {
    margin: 10px auto 0; width: 18px; height: 18px; border-radius: 50%;
    border: 2px solid #f5c473; border-right-color: transparent;
    animation: spin .9s linear infinite; opacity: 0; transition: opacity .8s ease;
  }
  .spinner.show { opacity: 1; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">The Curse is Bound!</h1>
    <p class="intro">
      You have contained the witch’s power, yet the darkness still stirs.
      One final act must be done.
    </p>

    <div class="card">
      <p class="prompt">Inscribe your name(s) upon the wall to complete the final rite.</p>

      <form id="ritualForm" autocomplete="off" novalidate>
        <input id="names" name="names" type="text" placeholder="Enter names here, separated by commas" />
        <div id="preview" class="preview" aria-live="polite"></div>

        <div class="actions">
          <button type="submit">conjure the ritual now</button>
        </div>

        <div class="msg" aria-live="polite">
          <div id="statusText" class="status-text"></div>
          <div id="spinner" class="spinner" role="progressbar" aria-hidden="true"></div>
        </div>
      </form>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
/* Set your HTTPS webhook when you start your Cloudflare/Nabu Casa tunnel: */
const WEBHOOK_URL = "https://YOUR-TUNNEL.trycloudflare.com/api/webhook/witch_winner";

/* Optional local testing (same network, no HTTPS):
   add ?local=1 to the page URL and it will post to your LAN HA instead. */
const LOCAL_HA_URL = "http://10.0.0.90:8123/api/webhook/witch_winner";
/* ---------------------------- */

function formatListWithAnd(raw){
  const parts = (raw || '')
    .split(',')
    .map(s => s.trim())
    .filter(Boolean);
  if (parts.length === 0) return '';
  if (parts.length === 1) return parts[0];
  if (parts.length === 2) return parts[0] + ' and ' + parts[1];
  return parts.slice(0, -1).join(', ') + ', and ' + parts[parts.length - 1];
}

const form = document.getElementById('ritualForm');
const input = document.getElementById('names');
const preview = document.getElementById('preview');
const statusText = document.getElementById('statusText');
const spinner = document.getElementById('spinner');

function updatePreview(){
  const formatted = formatListWithAnd(input.value);
  preview.textContent = formatted ? `Your inscription appears as so: “${formatted}”` : '';
}
input.addEventListener('input', updatePreview);
updatePreview();

function pickWebhook() {
  const params = new URLSearchParams(location.search);
  if (params.get('local') === '1') return LOCAL_HA_URL;
  return WEBHOOK_URL;
}

async function sendToHA(formatted) {
  const url = pickWebhook();
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    // We send a single string so it renders on one line in your overlay
    body: JSON.stringify({ names: formatted })
  });
  if (!res.ok) throw new Error(`HA webhook error: ${res.status}`);
}

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const formatted = formatListWithAnd(input.value);

  if (!formatted) {
    statusText.textContent = 'Add at least one name.';
    statusText.classList.add('show');
    return;
  }

  // Lock inputs to prevent double fire
  [...form.elements].forEach(el => el.disabled = true);

  // Stage 1 — show first line + spinner
  statusText.textContent = '…something mysterious is happening…';
  statusText.classList.add('show');
  spinner.classList.add('show');

  try {
    // Fire the webhook to HA (this triggers your whole finale)
    await sendToHA(formatted);
  } catch (err) {
    // If this fails, show message and unlock form
    spinner.classList.remove('show');
    statusText.textContent = 'Could not reach the ritual altar. Check the tunnel URL.';
    console.error(err);
    [...form.elements].forEach(el => el.disabled = false);
    return;
  }

  // After 6s: fade to stage 2 message
  setTimeout(()=>{
    statusText.classList.remove('show');
    setTimeout(()=>{
      statusText.textContent = '…the ritual is working…';
      statusText.classList.add('show');
    }, 800);
  }, 6000);

  // After another 6s → navigate to the end page
  setTimeout(()=>{
    window.location.href = './theend.html';
  }, 12000);
});
</script>
</body>
</html>
